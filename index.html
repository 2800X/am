import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Volume2, VolumeX } from 'lucide-react';

const AM1Workout = () => {
  const [isRunning, setIsRunning] = useState(false);
  const [currentPhase, setCurrentPhase] = useState(1);
  const [phaseTime, setPhaseTime] = useState(0);
  const [totalTime, setTotalTime] = useState(0);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [showLog, setShowLog] = useState(false);
  const [workoutLog, setWorkoutLog] = useState([]);
  
  // Timestamp-based tracking
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const [sessionPauseTime, setSessionPauseTime] = useState(null);
  const [totalPausedTime, setTotalPausedTime] = useState(0);
  const [phaseStartTime, setPhaseStartTime] = useState(null);
  
  const intervalRef = useRef(null);
  const audioContextRef = useRef(null);

  const phases = [
    { id: 1, name: 'SLOW', duration: 60, color: 'bg-blue-500', textColor: 'text-blue-100' },
    { id: 2, name: 'NORMAL', duration: 60, color: 'bg-green-500', textColor: 'text-green-100' },
    { id: 3, name: 'FAST', duration: 60, color: 'bg-red-500', textColor: 'text-red-100' }
  ];

  const currentPhaseData = phases.find(p => p.id === currentPhase);
  const totalWorkoutTime = 15 * 60; // 15 minutes in seconds

  // Sound function
  const playBeep = (frequency = 800, duration = 200) => {
    if (!soundEnabled) return;
    
    try {
      if (!audioContextRef.current) {
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      }
      
      const oscillator = audioContextRef.current.createOscillator();
      const gainNode = audioContextRef.current.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContextRef.current.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContextRef.current.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContextRef.current.currentTime + duration / 1000);
      
      oscillator.start();
      oscillator.stop(audioContextRef.current.currentTime + duration / 1000);
    } catch (error) {
      console.log('Audio not available');
    }
  };

  // Voice announcement function
  const speakPhase = (phaseName) => {
    if (!soundEnabled) return;
    
    try {
      const utterance = new SpeechSynthesisUtterance(phaseName.toLowerCase());
      utterance.rate = 1.2;
      utterance.volume = 0.8;
      utterance.pitch = 1.0;
      window.speechSynthesis.speak(utterance);
    } catch (error) {
      console.log('Speech synthesis not available');
    }
  };

  // Save/load session state
  const saveActiveSession = () => {
    if (sessionStartTime) {
      const activeSession = {
        sessionStartTime,
        totalPausedTime,
        sessionPauseTime,
        currentPhase,
        phaseStartTime,
        lastSaveTime: Date.now()
      };
      
      // Store in memory (no localStorage in Claude artifacts)
      window.am1ActiveSession = activeSession;
    }
  };

  const clearActiveSession = () => {
    delete window.am1ActiveSession;
  };

  const restoreActiveSession = () => {
    const activeSession = window.am1ActiveSession;
    if (activeSession) {
      const now = Date.now();
      const timeSinceLastSave = now - activeSession.lastSaveTime;
      
      // Only restore if session was saved within the last hour
      if (timeSinceLastSave < 60 * 60 * 1000) {
        const sessionElapsed = now - activeSession.sessionStartTime - activeSession.totalPausedTime;
        
        // Only restore if session hasn't exceeded 15 minutes
        if (sessionElapsed < totalWorkoutTime * 1000) {
          if (window.confirm(
            `Found an interrupted workout session!\n\n` +
            `Session was running for: ${Math.floor(sessionElapsed / (1000 * 60))} minutes ${Math.floor((sessionElapsed % (1000 * 60)) / 1000)} seconds\n` +
            `Current phase: ${phases.find(p => p.id === activeSession.currentPhase)?.name}\n\n` +
            `Would you like to restore this session?`
          )) {
            // Restore session state
            setSessionStartTime(activeSession.sessionStartTime);
            setTotalPausedTime(activeSession.totalPausedTime);
            setSessionPauseTime(null);
            setCurrentPhase(activeSession.currentPhase);
            setPhaseStartTime(activeSession.phaseStartTime);
            
            // Resume timer
            setIsRunning(true);
            return true;
          }
        }
      }
      
      // Clear old session if not restored
      clearActiveSession();
    }
    return false;
  };

  // Accurate timer update using timestamps
  const updateTimer = () => {
    if (!sessionStartTime) return;
    
    const currentTime = Date.now();
    const elapsedTime = Math.floor((currentTime - sessionStartTime - totalPausedTime) / 1000);
    const remainingTime = Math.max(0, totalWorkoutTime - elapsedTime);
    
    setTotalTime(elapsedTime);
    
    // Calculate phase time
    const phaseElapsed = Math.floor((currentTime - phaseStartTime - totalPausedTime) / 1000);
    setPhaseTime(phaseElapsed);
    
    // Check for phase change
    if (phaseElapsed >= currentPhaseData.duration) {
      // Phase complete - play sound and move to next phase
      playBeep(1000, 300);
      
      const nextPhase = currentPhase === 3 ? 1 : currentPhase + 1;
      const nextPhaseData = phases.find(p => p.id === nextPhase);
      
      setCurrentPhase(nextPhase);
      setPhaseStartTime(currentTime);
      
      // Announce the next phase
      setTimeout(() => {
        speakPhase(nextPhaseData.name);
      }, 100);
    }
    
    // Check if workout is complete
    if (remainingTime <= 0) {
      // Workout complete - log it and play sound
      const completedWorkout = {
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
        duration: '15 minutes',
        cycles: 5
      };
      setWorkoutLog(prevLog => [completedWorkout, ...prevLog]);
      playBeep(1200, 500);
      setIsRunning(false);
      clearActiveSession();
    }
  };

  // Timer effect
  useEffect(() => {
    if (isRunning && sessionStartTime) {
      // Update immediately
      updateTimer();
      // Then update every 100ms for smooth display
      intervalRef.current = setInterval(updateTimer, 100);
      
      // Auto-save every 10 seconds
      const saveInterval = setInterval(saveActiveSession, 10000);
      
      return () => {
        clearInterval(intervalRef.current);
        clearInterval(saveInterval);
      };
    } else {
      clearInterval(intervalRef.current);
    }
  }, [isRunning, sessionStartTime, currentPhase, phaseStartTime, totalPausedTime]);

  // Check for active session on mount
  useEffect(() => {
    const restored = restoreActiveSession();
    if (restored) {
      // Session was restored, phase start time needs to be recalculated
      const now = Date.now();
      const sessionElapsed = now - sessionStartTime - totalPausedTime;
      const cycleTime = 3 * 60 * 1000; // 3 minutes per cycle
      const currentCycleTime = sessionElapsed % cycleTime;
      
      // Calculate which phase we should be in and when it started
      let phaseInCycle;
      let phaseStart;
      
      if (currentCycleTime < 60000) { // First minute - Slow
        phaseInCycle = 1;
        phaseStart = now - (currentCycleTime);
      } else if (currentCycleTime < 120000) { // Second minute - Normal
        phaseInCycle = 2;
        phaseStart = now - (currentCycleTime - 60000);
      } else { // Third minute - Fast
        phaseInCycle = 3;
        phaseStart = now - (currentCycleTime - 120000);
      }
      
      setCurrentPhase(phaseInCycle);
      setPhaseStartTime(phaseStart);
    }
  }, []);

  // Handle page visibility changes
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (isRunning && !document.hidden) {
        // Page became visible again - update timer immediately
        updateTimer();
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
  }, [isRunning]);

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const getProgress = () => {
    return (phaseTime / currentPhaseData.duration) * 100;
  };

  const getTotalProgress = () => {
    return (totalTime / totalWorkoutTime) * 100;
  };

  const handleStart = () => {
    if (!isRunning) {
      if (!sessionStartTime) {
        // Start new session
        const now = Date.now();
        setSessionStartTime(now);
        setPhaseStartTime(now);
        setSessionPauseTime(null);
        setTotalPausedTime(0);
        setCurrentPhase(1);
        playBeep(600, 150);
        // Announce the starting phase
        setTimeout(() => {
          speakPhase(currentPhaseData.name);
        }, 200);
      } else if (sessionPauseTime) {
        // Resume from pause
        const now = Date.now();
        setTotalPausedTime(prev => prev + (now - sessionPauseTime));
        setSessionPauseTime(null);
      }
      setIsRunning(true);
    }
  };

  const handlePause = () => {
    setIsRunning(false);
    setSessionPauseTime(Date.now());
    playBeep(400, 150);
  };

  const handleReset = () => {
    setIsRunning(false);
    setSessionStartTime(null);
    setSessionPauseTime(null);
    setTotalPausedTime(0);
    setPhaseStartTime(null);
    setCurrentPhase(1);
    setPhaseTime(0);
    setTotalTime(0);
    clearActiveSession();
    playBeep(300, 100);
  };

  const isWorkoutComplete = totalTime >= totalWorkoutTime;
  const remainingWorkoutTime = totalWorkoutTime - totalTime;

  // Get schedule recommendation
  const getScheduleStatus = () => {
    if (workoutLog.length === 0) return { status: 'start', message: 'Ready to start your first workout!' };
    
    const lastWorkout = workoutLog[0];
    const lastWorkoutDate = new Date(lastWorkout.date);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const isToday = lastWorkoutDate.toDateString() === today.toDateString();
    const isYesterday = lastWorkoutDate.toDateString() === yesterday.toDateString();
    
    if (isToday) {
      return { status: 'rest', message: 'Rest day! You worked out today.' };
    } else if (isYesterday) {
      return { status: 'workout', message: 'Workout day! Ready for your next session.' };
    } else {
      return { status: 'workout', message: 'Time to get back to your routine!' };
    }
  };

  const scheduleStatus = getScheduleStatus();

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6 flex items-center justify-center">
      <div className="max-w-md w-full space-y-6">
        {/* Header */}
        <div className="text-center">
          <h1 className="text-4xl font-bold text-white mb-2">AM1</h1>
          <p className="text-gray-400">3-Phase Workout Timer</p>
        </div>

        {/* Schedule Status */}
        <div className={`rounded-lg p-4 ${scheduleStatus.status === 'workout' ? 'bg-green-900 border-green-500' : 'bg-orange-900 border-orange-500'} border-2`}>
          <div className="text-center">
            <div className="text-lg font-semibold mb-1">
              {scheduleStatus.status === 'workout' ? 'üí™ Workout Day' : 'üò¥ Rest Day'}
            </div>
            <p className="text-sm opacity-90">{scheduleStatus.message}</p>
          </div>
        </div>

        {/* Current Phase Display */}
        <div className={`${currentPhaseData.color} rounded-2xl p-8 text-center transition-colors duration-500`}>
          <div className="text-6xl font-bold mb-2">
            {currentPhaseData.name}
          </div>
          <div className="text-2xl opacity-90 mb-4">
            Phase {currentPhase} of 3
          </div>
          <div className="text-3xl font-mono">
            {formatTime(Math.max(0, currentPhaseData.duration - phaseTime))}
          </div>
        </div>

        {/* Phase Progress Bar */}
        <div className="bg-gray-800 rounded-full h-3 overflow-hidden">
          <div 
            className={`h-full ${currentPhaseData.color} transition-all duration-1000 ease-linear`}
            style={{ width: `${getProgress()}%` }}
          />
        </div>

        {/* Total Workout Progress */}
        <div className="bg-gray-800 rounded-lg p-4">
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm text-gray-400">Total Workout</span>
            <span className="text-sm text-gray-400">{formatTime(remainingWorkoutTime)} remaining</span>
          </div>
          <div className="bg-gray-700 rounded-full h-2 overflow-hidden">
            <div 
              className="h-full bg-white transition-all duration-1000 ease-linear"
              style={{ width: `${getTotalProgress()}%` }}
            />
          </div>
        </div>

        {/* Controls */}
        <div className="flex justify-center space-x-4">
          {!isRunning ? (
            <button
              onClick={handleStart}
              disabled={isWorkoutComplete}
              className="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed px-8 py-4 rounded-full flex items-center space-x-2 text-lg font-semibold transition-colors"
            >
              <Play size={24} />
              <span>{sessionStartTime ? 'Resume' : 'Start'}</span>
            </button>
          ) : (
            <button
              onClick={handlePause}
              className="bg-yellow-600 hover:bg-yellow-700 px-8 py-4 rounded-full flex items-center space-x-2 text-lg font-semibold transition-colors"
            >
              <Pause size={24} />
              <span>Pause</span>
            </button>
          )}
          
          <button
            onClick={handleReset}
            className="bg-gray-600 hover:bg-gray-700 px-8 py-4 rounded-full flex items-center space-x-2 text-lg font-semibold transition-colors"
          >
            <RotateCcw size={24} />
            <span>Reset</span>
          </button>

          <button
            onClick={() => setSoundEnabled(!soundEnabled)}
            className={`${soundEnabled ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-700'} px-4 py-4 rounded-full transition-colors`}
          >
            {soundEnabled ? <Volume2 size={24} /> : <VolumeX size={24} />}
          </button>

          <button
            onClick={() => setShowLog(!showLog)}
            className="bg-purple-600 hover:bg-purple-700 px-4 py-4 rounded-full transition-colors"
          >
            üìä
          </button>
        </div>

        {/* Workout Log */}
        {showLog && (
          <div className="bg-gray-800 rounded-lg p-4">
            <div className="flex justify-between items-center mb-3">
              <h3 className="text-lg font-semibold text-white">Workout Log</h3>
              <span className="text-sm text-gray-400">{workoutLog.length} sessions</span>
            </div>
            
            {workoutLog.length === 0 ? (
              <p className="text-gray-400 text-center py-4">No workouts completed yet. Start your first session!</p>
            ) : (
              <div className="space-y-2 max-h-48 overflow-y-auto">
                {workoutLog.map((workout, index) => (
                  <div key={index} className="bg-gray-700 rounded p-3 flex justify-between items-center">
                    <div>
                      <div className="text-white font-medium">{workout.date}</div>
                      <div className="text-gray-400 text-sm">{workout.time}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-green-400 font-medium">‚úì Completed</div>
                      <div className="text-gray-400 text-sm">{workout.duration}</div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

        {/* Phase Schedule */}
        <div className="bg-gray-800 rounded-lg p-4 space-y-2">
          <h3 className="text-sm font-semibold text-gray-300 mb-3">Phase Schedule</h3>
          {phases.map((phase, index) => (
            <div key={phase.id} className="flex justify-between items-center">
              <div className="flex items-center space-x-2">
                <div className={`w-3 h-3 rounded-full ${phase.color}`} />
                <span className={`text-sm ${currentPhase === phase.id ? 'text-white font-semibold' : 'text-gray-400'}`}>
                  {phase.name}
                </span>
              </div>
              <span className="text-sm text-gray-400">{formatTime(phase.duration)}</span>
            </div>
          ))}
        </div>

        {isWorkoutComplete && (
          <div className="bg-green-900 border-2 border-green-500 rounded-lg p-4 text-center">
            <div className="text-2xl font-bold text-green-300 mb-2">üéâ Workout Complete!</div>
            <p className="text-green-200">Great job finishing your 15-minute AM1 session!</p>
          </div>
        )}

        {/* Session Recovery Notification */}
        {sessionStartTime && !isRunning && sessionPauseTime && (
          <div className="bg-blue-900 border-2 border-blue-500 rounded-lg p-4 text-center">
            <div className="text-lg font-bold text-blue-300 mb-2">‚è∏Ô∏è Session Paused</div>
            <p className="text-blue-200 text-sm">Your workout will resume from where you left off when you hit Resume!</p>
          </div>
        )}
      </div>
    </div>
  );
};

export default AM1Workout;
